<!DOCTYPE html>
<html>
<head>
  <title>WebGIS c∆° b·∫£n v·ªõi Leaflet, th√™m l·ªõp n·ªÅn</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    
    /* Style cho thanh tr∆∞·ª£t opacity */
    .opacity-control {
      background: white;
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      font-family: Arial, sans-serif;
      font-size: 12px;
    }
    
    .opacity-control label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .opacity-control input[type="range"] {
      width: 150px;
      cursor: pointer;
    }
    
    .opacity-value {
      display: inline-block;
      margin-left: 10px;
      color: #ff6600;
      font-weight: bold;
      min-width: 30px;
    }
  </style>
</head>
<body>
<h3 style="text-align:center;">WebGIS c∆° b·∫£n v·ªõi Leaflet.js, th√™m l·ªõp n·ªÅn ·∫£nh v·ªá tinh</h3>
<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
  var map = L.map('map');
  
  // Bi·∫øn ƒë·ªÉ l∆∞u view m·∫∑c ƒë·ªãnh
  var defaultView = null;
  
  // Bi·∫øn ƒë·ªÉ l∆∞u layer GeoJSON
  var usaStatesLayer = null;
  
  // Bi·∫øn ƒë·ªÉ l∆∞u ƒë·ªô trong su·ªët hi·ªán t·∫°i
  var currentOpacity = 0.5;
  
  // C√°c layer n·ªÅn
  var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0','mt1','mt2','mt3'],
    attribution: '¬© Google Maps'
  });
  
  var googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0','mt1','mt2','mt3'],
    attribution: '¬© Google Satellite'
  });
  
  var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0','mt1','mt2','mt3'],
    attribution: '¬© Google Terrain'
  });
  
  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  });

   var osmVector = L.tileLayer('https://basemaps.arcgis.com/arcgis/rest/services/OpenStreetMap_v2/VectorTileServer', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'  
  
  // Th√™m c√°c l·ªõp CARTO
  var cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
    subdomains: 'abcd'
  });
  
  var cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
    subdomains: 'abcd'
  });
  
  var cartoVoyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors ¬© CARTO',
    subdomains: 'abcd'
  });
  
  // Th√™m m·∫∑c ƒë·ªãnh l√† OpenStreetMap
  osm.addTo(map);
  
  // ===== N√öT HOME THEO CHU·∫®N LEAFLET =====
  L.Control.Home = L.Control.extend({
    options: {
      position: 'topleft'
    },
    
    onAdd: function(map) {
      var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
      
      container.style.backgroundColor = 'white';
      container.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJtMyA5IDktNyA5IDd2MTFhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJ6Ii8+PHBvbHlsaW5lIHBvaW50cz0iOSAyMiA5IDEyIDE1IDEyIDE1IDIyIi8+PC9zdmc+')";
      container.style.backgroundSize = '20px 20px';
      container.style.backgroundPosition = 'center';
      container.style.backgroundRepeat = 'no-repeat';
      container.style.width = '30px';
      container.style.height = '30px';
      container.style.cursor = 'pointer';
      container.title = 'Quay v·ªÅ v·ªã tr√≠ m·∫∑c ƒë·ªãnh';
      
      container.onclick = function() {
        if (defaultView) {
          map.fitBounds(defaultView);
        }
      }
      
      return container;
    }
  });
  
  L.control.home = function(opts) {
    return new L.Control.Home(opts);
  }
  
  L.control.home({ position: 'topleft' }).addTo(map);
  
  // ===== THANH TR∆Ø·ª¢T KI·ªÇM SO√ÅT ƒê·ªò TRONG SU·ªêT =====
  L.Control.OpacitySlider = L.Control.extend({
    options: {
      position: 'topright'
    },
    
    onAdd: function(map) {
      var container = L.DomUtil.create('div', 'leaflet-control opacity-control');
      
      var label = L.DomUtil.create('label', '', container);
      label.innerHTML = 'üé® ƒê·ªô trong su·ªët:';
      
      var sliderContainer = L.DomUtil.create('div', '', container);
      
      var slider = L.DomUtil.create('input', '', sliderContainer);
      slider.type = 'range';
      slider.min = '0';
      slider.max = '1';
      slider.step = '0.1';
      slider.value = currentOpacity;
      
      var valueDisplay = L.DomUtil.create('span', 'opacity-value', sliderContainer);
      valueDisplay.innerHTML = currentOpacity;
      
      L.DomEvent.on(slider, 'input', function(e) {
        currentOpacity = parseFloat(e.target.value);
        valueDisplay.innerHTML = currentOpacity.toFixed(1);
        
        if (usaStatesLayer) {
          usaStatesLayer.setStyle({
            fillOpacity: currentOpacity
          });
        }
      });
      
      // NgƒÉn s·ª± ki·ªán click lan ra map
      L.DomEvent.disableClickPropagation(container);
      L.DomEvent.disableScrollPropagation(container);
      
      return container;
    }
  });
  
  L.control.opacitySlider = function(opts) {
    return new L.Control.OpacitySlider(opts);
  }
  
  L.control.opacitySlider({ position: 'topright' }).addTo(map);
  
  // ===== LOAD FILE GEOJSON =====
  fetch('polygon_stateusa_27112025.geojson')
    .then(response => response.json())
    .then(data => {
      // Ki·ªÉm tra thu·ªôc t√≠nh
      console.log('Thu·ªôc t√≠nh c√≥ s·∫µn:', data.features[0].properties);
      
      // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i auto zoom (d√πng trong closure)
      var autoZoomEnabled = true;
      
      usaStatesLayer = L.geoJSON(data, {
        style: function(feature) {
          // T·∫°o m√†u ng·∫´u nhi√™n cho m·ªói bang
          var randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
          return {
            color: '#2c3e50',
            weight: 2,
            opacity: 1,
            fillColor: randomColor,
            fillOpacity: currentOpacity
          };
        },
        
        onEachFeature: function(feature, layer) {
          // T·∫°o n·ªôi dung popup
          var popupContent = '<div style="font-family: Arial;">';
          
          if (feature.properties.ref) {
            popupContent += '<h3 style="margin: 0 0 10px 0; color: #2c5282;">üá∫üá∏ ' + feature.properties.ref + '</h3>';
          } else {
            popupContent += '<h3 style="margin: 0 0 10px 0; color: #2c5282;">üá∫üá∏ Bang M·ªπ</h3>';
          }
          
          for (var prop in feature.properties) {
            popupContent += '<b>' + prop + ':</b> ' + feature.properties[prop] + '<br>';
          }
          popupContent += '</div>';
          
          layer.bindPopup(popupContent);
          
          // Hi·ªáu ·ª©ng hover v√† click
          layer.on({
            mouseover: function(e) {
              var layer = e.target;
              layer.setStyle({
                weight: 4,
                color: '#ff6600',
                fillOpacity: Math.min(currentOpacity + 0.3, 1)
              });
            },
            mouseout: function(e) {
              usaStatesLayer.resetStyle(e.target);
            },
            click: function(e) {
              // L·∫•y tr·∫°ng th√°i auto zoom t·ª´ checkbox
              var checkbox = document.getElementById('autoZoomCheckbox');
              if (checkbox && checkbox.checked) {
                map.fitBounds(e.target.getBounds());
              }
            }
          });
        }
      }).addTo(map);
      
      // L∆∞u v·ªã tr√≠ m·∫∑c ƒë·ªãnh
      defaultView = usaStatesLayer.getBounds();
      map.fitBounds(defaultView);
      
      // ===== T·∫†O CONTROL LAYERS V·ªöI AUTO ZOOM =====
      var baseMaps = {
        "üåç OpenStreetMap": osm,
        "üõ∞Ô∏è Google Hybrid": googleHybrid,
        "üó∫Ô∏è Google Satellite": googleSatellite,
        "‚õ∞Ô∏è Google Terrain": googleTerrain,
        "üí° CARTO Light": cartoLight,
        "üåô CARTO Dark": cartoDark,
        "üó∫Ô∏è CARTO Voyager": cartoVoyager
      };
      
      var overlayMaps = {
        "üó∫Ô∏è Bang M·ªπ": usaStatesLayer,
        '<input type="checkbox" id="autoZoomCheckbox" checked> <label for="autoZoomCheckbox" style="font-weight:normal; cursor:pointer;">üîç Auto Zoom khi click</label>': L.layerGroup() // Dummy layer
      };
      
      var layerControl = L.control.layers(baseMaps, overlayMaps, {
        collapsed: false
      }).addTo(map);
      
      // Style cho checkbox trong layer control
      setTimeout(function() {
        var checkbox = document.getElementById('autoZoomCheckbox');
        if (checkbox) {
          checkbox.style.marginRight = '5px';
          checkbox.style.cursor = 'pointer';
          
          // NgƒÉn checkbox t·∫Øt layer
          checkbox.addEventListener('click', function(e) {
            e.stopPropagation();
          });
          
          // NgƒÉn label t·∫Øt layer
          var label = checkbox.nextElementSibling;
          if (label) {
            label.addEventListener('click', function(e) {
              e.stopPropagation();
              checkbox.checked = !checkbox.checked;
            });
          }
        }
      }, 100);
      
    })
    .catch(error => {
      console.error('L·ªói khi load GeoJSON:', error);
      alert('Kh√¥ng th·ªÉ t·∫£i file polygon_stateusa_27112025.geojson. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.');
    });
</script>
</body>
</html>

